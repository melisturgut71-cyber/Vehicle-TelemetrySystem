#include <WiFi.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>

// ====== WiFi Bilgilerin ======
const char* ssid = "wifi name";
const char* password = "wifi password";

// ====== MQTT Broker (HiveMQ Public) ======
const char* mqtt_server = "broker.hivemq.com";
const int mqtt_port = 1883;
const char* topic_publish = "arac/simulasyon";
const char* topic_subscribe = "arac/kontrol";

// WiFi ve MQTT client nesneleri
WiFiClient espClient;
PubSubClient client(espClient);

// Durum değişkenleri
bool motorCalisiyor = false;
bool kapilarAcik = false;
bool camlarAcik = false;
String durumMesaji = "";

// Simülasyon değişkenleri
int hiz = 0;
int rpm = 1000;
int sicaklik = 70;

void setup_wifi() {
  delay(10);
  Serial.println();
  Serial.print("WiFi'ye baglaniyor: ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.println("WiFi baglandi!");
  Serial.print("IP Adresi: ");
  Serial.println(WiFi.localIP());
}

void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("MQTT Mesaji Geldi [");
  Serial.print(topic);
  Serial.print("]: ");
  
  String message;
  for (int i = 0; i < length; i++) {
    message += (char)payload[i];
  }
  Serial.println(message);

  // JSON mesajını parse et
  DynamicJsonDocument doc(256);
  DeserializationError error = deserializeJson(doc, message);
  
  if (error) {
    Serial.print("JSON Parse Hatasi: ");
    Serial.println(error.c_str());
    return;
  }

  // Komutları işle
  if (doc.containsKey("motor")) {
    motorCalisiyor = doc["motor"];
    Serial.println(motorCalisiyor ? "Motor CALISTIR komutu" : "Motor DURDUR komutu");
  }
  
  if (doc.containsKey("kapilar")) {
    kapilarAcik = doc["kapilar"];
    Serial.println(kapilarAcik ? "KAPILAR ACIK komutu" : "KAPILAR KAPALI komutu");
  }
  
  if (doc.containsKey("camlar")) {
    camlarAcik = doc["camlar"];
    Serial.println(camlarAcik ? "CAMLAR ACIK komutu" : "CAMLAR KAPALI komutu");
  }

  // Simülasyon parametreleri
  if (doc.containsKey("hiz")) {
    hiz = doc["hiz"];
    Serial.print("Hiz ayarlandi: ");
    Serial.println(hiz);
  }
  
  if (doc.containsKey("rpm")) {
    rpm = doc["rpm"];
    Serial.print("RPM ayarlandi: ");
    Serial.println(rpm);
  }
  
  if (doc.containsKey("sicaklik")) {
    sicaklik = doc["sicaklik"];
    Serial.print("Sicaklik ayarlandi: ");
    Serial.println(sicaklik);
  }

  durumMesajiGuncelle();
}

void reconnect() {
  while (!client.connected()) {
    Serial.print("MQTT'ye baglaniliyor...");
    if (client.connect("ESP32ClientSimulasyon")) {
      Serial.println("baglandi!");
      client.subscribe(topic_subscribe);
      Serial.print("Topic'e subscribe olundu: ");
      Serial.println(topic_subscribe);
    } else {
      Serial.print("hata, rc=");
      Serial.print(client.state());
      Serial.println(" 5 sn sonra tekrar denenecek");
      delay(5000);
    }
  }
}

void durumMesajiGuncelle() {
  durumMesaji = "";
  
  if (motorCalisiyor) {
    durumMesaji += "Motor calisiyor, ";
  } else {
    durumMesaji += "Motor durdu, ";
  }
  
  if (kapilarAcik) {
    durumMesaji += "Kapilar acik, ";
  } else {
    durumMesaji += "Kapilar kapali, ";
  }
  
  if (camlarAcik) {
    durumMesaji += "Camlar acik";
  } else {
    durumMesaji += "Camlar kapali";
  }
  
  // Seri ekrana durum mesajını yazdır - TÜRKÇE KARAKTERSİZ
  Serial.println("=== ARAC DURUMU ===");
  if (motorCalisiyor) {
    Serial.println("✓ Motor CALISIYOR");
  } else {
    Serial.println("✗ Motor DURDU");
  }
  
  if (kapilarAcik) {
    Serial.println("✗ KAPILAR ACIK");
  } else {
    Serial.println("✓ KAPILAR KAPALI");
  }
  
  if (camlarAcik) {
    Serial.println("✗ CAMLAR ACIK");
  } else {
    Serial.println("✓ CAMLAR KAPALI");
  }
  Serial.println("===================");
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("Arac Simulasyonu Baslatiliyor...");
  Serial.println("===============================");
  
  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(callback);
  
  // Rastgele başlangıç durumları
  randomSeed(analogRead(0));
  motorCalisiyor = random(0, 2);
  kapilarAcik = random(0, 2);
  camlarAcik = random(0, 2);
  durumMesajiGuncelle();
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  // Motor çalışmıyorsa hız ve RPM sıfırlanır
  if (!motorCalisiyor) {
    hiz = 0;
    rpm = 0;
  } else {
    // Motor çalışıyorsa simülasyon devam eder
    if (hiz < 120) hiz += 1;
    if (rpm < 6000 && rpm > 0) rpm += 50;
    if (sicaklik < 110) sicaklik += 1;
  }

  // Her 5 saniyede bir seri ekrana durum yazdır
  static unsigned long sonSerialYazdirma = 0;
  if (millis() - sonSerialYazdirma > 5000) {
    Serial.println("\n--- GUNCEL DURUM ---");
    Serial.print("Hiz: "); Serial.print(hiz); Serial.println(" km/h");
    Serial.print("RPM: "); Serial.println(rpm);
    Serial.print("Motor Sicakligi: "); Serial.print(sicaklik); Serial.println(" °C");
    
    Serial.print("Motor: ");
    Serial.println(motorCalisiyor ? "CALISIYOR" : "DURDU");
    
    Serial.print("Kapilar: ");
    Serial.println(kapilarAcik ? "ACIK" : "KAPALI");
    
    Serial.print("Camlar: ");
    Serial.println(camlarAcik ? "ACIK" : "KAPALI");
    Serial.println("-------------------");
    
    sonSerialYazdirma = millis();
  }

  // JSON verisi hazırlama
  String jsonData = "{";
  jsonData += "\"hiz\":" + String(hiz) + ",";
  jsonData += "\"rpm\":" + String(rpm) + ",";
  jsonData += "\"sicaklik\":" + String(sicaklik) + ",";
  jsonData += "\"motor_calisiyor\":" + String(motorCalisiyor ? "true" : "false") + ",";
  jsonData += "\"kapilar_acik\":" + String(kapilarAcik ? "true" : "false") + ",";
  jsonData += "\"camlar_acik\":" + String(camlarAcik ? "true" : "false") + ",";
  jsonData += "\"durum_mesaji\":\"" + durumMesaji + "\"";
  jsonData += "}";

  // MQTT'ye gönder
  client.publish(topic_publish, jsonData.c_str());
  Serial.println("MQTT'ye gonderildi: " + jsonData);

  delay(5000); // 5 saniyede bir gönder
}
